<div class="card shadow mb-4" id="alternative-explorer-panel">
    <div class="card-header py-3 bg-gradient-info text-white d-flex align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold"><i class="fas fa-project-diagram"></i> Project Multiverse (Alternative Builds)
        </h6>
        <span class="badge badge-light text-info">PREVIEW MODE</span>
    </div>
    <div class="card-body bg-light">
        <!-- Branch List -->
        <div id="branch-list-container">
            <p class="text-xs text-uppercase font-weight-bold text-gray-500 mb-2">Available Branches</p>
            <div id="branch-items" class="list-group list-group-flush border-bottom">
                <!-- Branches injected here -->
                <div class="text-center p-3 text-gray-400">Select a project to see its multiverse...</div>
            </div>
        </div>

        <!-- Create Branch Form -->
        <div class="mt-3 p-3 bg-white border rounded">
            <p class="small font-weight-bold text-uppercase text-info mb-2">Create New Alternative</p>
            <div class="form-group mb-2">
                <input type="text" id="new-branch-name" class="form-control form-control-sm"
                    placeholder="Branch Name (e.g. Optimized for Finish)">
            </div>
            <div class="form-group mb-2">
                <small class="text-gray-500">Overrides (JSON):</small>
                <textarea id="branch-overrides" class="form-control form-control-sm text-xs"
                    style="font-family:monospace; height:60px;">{"feed_rate": 1500}</textarea>
            </div>
            <button class="btn btn-info btn-block btn-sm" onclick="createNewBranch()">
                <i class="fas fa-code-branch"></i> GENERATE ALTERNATIVE BUILD
            </button>
        </div>
    </div>
</div>

<script>
    let activeParentId = null;

    function loadProjectMultiverse(jobId) {
        activeParentId = jobId;
        const container = document.getElementById('branch-items');
        container.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Loading linege...</div>';

        // Mock branch fetch or real API call
        // In a real app we'd fetch from /api/projects/branches?job_id=jobId
        setTimeout(() => {
            const mockBranches = [
                { id: jobId, name: "Main/Master", status: "COMPLETED", current: true },
                { id: "BR-X123", name: "Finish Optimized", status: "PREVIEW", current: false }
            ];
            renderBranches(mockBranches);
        }, 500);
    }

    function renderBranches(branches) {
        const container = document.getElementById('branch-items');
        container.innerHTML = '';

        branches.forEach(b => {
            const item = document.createElement('a');
            item.href = "#";
            item.className = `list-group-item list-group-item-action d-flex justify-content-between align-items-center ${b.current ? 'active font-weight-bold' : ''}`;
            item.onclick = (e) => { e.preventDefault(); switchBranch(b.id); };

            const badgeClass = b.status === 'COMPLETED' ? 'badge-success' : 'badge-warning';
            item.innerHTML = `
                <div>${b.name} <br><small class="${b.current ? 'text-white' : 'text-gray-500'}">${b.id}</small></div>
                <span class="badge ${badgeClass} badge-pill">${b.status}</span>
            `;
            container.appendChild(item);
        });
    }

    function createNewBranch() {
        if (!activeParentId) {
            alert("Please select a project first.");
            return;
        }

        const name = document.getElementById('new-branch-name').value;
        const overridesText = document.getElementById('branch-overrides').value;

        if (!name) return;

        let overrides = {};
        try { overrides = JSON.parse(overridesText); } catch (e) { alert("Invalid JSON overrides"); return; }

        addLogLine("SYS", `MULTIVERSE_BRANCH_INITIATED: ${name}`);

        // API Call
        fetch('/api/projects/branch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                parent_id: activeParentId,
                branch_name: name,
                overrides: overrides
            })
        })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'SUCCESS') {
                    addLogLine("SYS", `BRANCH_CREATED: ${data.branch_id}`);
                    loadProjectMultiverse(activeParentId);
                    // Highlight the new branch in the UI (Bold)
                    document.getElementById('new-branch-name').value = '';
                } else {
                    alert("Branching failed: " + data.message);
                }
            });
    }

    function switchBranch(jobId) {
        console.log("Switching to branch:", jobId);
        addLogLine("SYS", `MULTIVERSE_SWITCH: LOADING_BUILD ${jobId}`);
        // In a real app, this would refresh the dashboard state for this Job ID
    }
</script>