"""
Developer SDK & API Client Generator ðŸ’»
Responsibility:
1. Auto-generate SDK clients for the API.
2. Provide code snippets for common operations.
3. Developer-friendly documentation generation.

DEVELOPERS! DEVELOPERS! DEVELOPERS! ðŸŽ‰
"""
from typing import Dict, Any, List, Optional
import json

class APIClientGenerator:
    """Generates code snippets and SDK clients for developers."""
    
    def __init__(self):
        self.base_url = "http://localhost:8000"
        self.supported_languages = ["python", "javascript", "curl", "typescript"]

    def get_python_client(self, endpoint: str, method: str = "GET", payload: dict = None) -> str:
        """Generates Python code snippet for API call."""
        if method.upper() == "GET":
            params = f"?{self._dict_to_query(payload)}" if payload else ""
            return f'''import requests

response = requests.get("{self.base_url}{endpoint}{params}", headers={{
    "Authorization": "Bearer YOUR_TOKEN"
}})
data = response.json()
print(data)'''
        else:
            payload_str = json.dumps(payload or {}, indent=4)
            return f'''import requests

response = requests.{method.lower()}("{self.base_url}{endpoint}", 
    json={payload_str},
    headers={{
        "Authorization": "Bearer YOUR_TOKEN",
        "Content-Type": "application/json"
    }}
)
data = response.json()
print(data)'''

    def get_javascript_client(self, endpoint: str, method: str = "GET", payload: dict = None) -> str:
        """Generates JavaScript/Fetch code snippet."""
        payload_str = json.dumps(payload or {}, indent=2)
        if method.upper() == "GET":
            return f'''const response = await fetch("{self.base_url}{endpoint}", {{
  method: "GET",
  headers: {{
    "Authorization": "Bearer YOUR_TOKEN"
  }}
}});
const data = await response.json();
console.log(data);'''
        else:
            return f'''const response = await fetch("{self.base_url}{endpoint}", {{
  method: "{method.upper()}",
  headers: {{
    "Authorization": "Bearer YOUR_TOKEN",
    "Content-Type": "application/json"
  }},
  body: JSON.stringify({payload_str})
}});
const data = await response.json();
console.log(data);'''

    def get_curl_command(self, endpoint: str, method: str = "GET", payload: dict = None) -> str:
        """Generates cURL command."""
        cmd = f'curl -X {method.upper()} "{self.base_url}{endpoint}"'
        cmd += ' -H "Authorization: Bearer YOUR_TOKEN"'
        if payload and method.upper() != "GET":
            cmd += ' -H "Content-Type: application/json"'
            cmd += f" -d '{json.dumps(payload)}'"
        return cmd

    def get_typescript_client(self, endpoint: str, method: str = "GET", payload: dict = None) -> str:
        """Generates TypeScript code snippet."""
        payload_str = json.dumps(payload or {}, indent=2)
        interface = """interface APIResponse {
  status: string;
  data?: any;
  error?: string;
}

"""
        if method.upper() == "GET":
            return interface + f'''const fetchData = async (): Promise<APIResponse> => {{
  const response = await fetch("{self.base_url}{endpoint}", {{
    method: "GET",
    headers: {{
      "Authorization": "Bearer YOUR_TOKEN"
    }}
  }});
  return response.json();
}};'''
        else:
            return interface + f'''const sendData = async (): Promise<APIResponse> => {{
  const response = await fetch("{self.base_url}{endpoint}", {{
    method: "{method.upper()}",
    headers: {{
      "Authorization": "Bearer YOUR_TOKEN",
      "Content-Type": "application/json"
    }},
    body: JSON.stringify({payload_str})
  }});
  return response.json();
}};'''

    def generate_snippet(self, language: str, endpoint: str, method: str = "GET", payload: dict = None) -> str:
        """Generates code snippet for specified language."""
        generators = {
            "python": self.get_python_client,
            "javascript": self.get_javascript_client,
            "curl": self.get_curl_command,
            "typescript": self.get_typescript_client
        }
        generator = generators.get(language.lower())
        if generator:
            return generator(endpoint, method, payload)
        return f"# Language '{language}' not supported. Available: {', '.join(self.supported_languages)}"

    def _dict_to_query(self, d: dict) -> str:
        if not d:
            return ""
        return "&".join(f"{k}={v}" for k, v in d.items())

    def get_full_sdk_template(self) -> str:
        """Returns a full Python SDK template."""
        return '''"""
FANUC RISE CNC Copilot SDK
Generated by Developer Tools ðŸš€
"""
import requests
from typing import Dict, Any, Optional

class CNCCopilotSDK:
    def __init__(self, base_url: str = "http://localhost:8000", token: str = None):
        self.base_url = base_url
        self.token = token
        self.headers = {"Authorization": f"Bearer {token}"} if token else {}

    def _request(self, method: str, endpoint: str, json: dict = None) -> Dict[str, Any]:
        url = f"{self.base_url}{endpoint}"
        response = requests.request(method, url, json=json, headers=self.headers)
        response.raise_for_status()
        return response.json()

    # Health
    def health(self) -> Dict[str, Any]:
        return self._request("GET", "/api/health")

    # Products
    def list_products(self) -> Dict[str, Any]:
        return self._request("GET", "/api/llm/products")

    def create_product(self, name: str, description: str = "") -> Dict[str, Any]:
        return self._request("POST", "/api/llm/products/add", {"name": name, "description": description})

    # G-Code
    def generate_gcode(self, product_id: str, format: str = "fanuc") -> Dict[str, Any]:
        return self._request("POST", f"/api/generate/{product_id}/gcode", {"format": format})

    # Config
    def get_config(self) -> Dict[str, Any]:
        return self._request("GET", "/api/config/params")

    def set_config(self, key: str, value: Any) -> Dict[str, Any]:
        return self._request("POST", f"/api/config/param/{key}", {"value": value})

    # Notifications
    def get_notifications(self) -> Dict[str, Any]:
        return self._request("GET", "/api/notifications")

    # Debug
    def debug_command(self, command: str) -> Dict[str, Any]:
        return self._request("POST", "/api/debug/console", {"command": command})


# Usage Example:
# sdk = CNCCopilotSDK(token="your_token_here")
# print(sdk.health())
# print(sdk.list_products())
'''


class CodeScaffolder:
    """Generates boilerplate code for new features."""
    
    def generate_component(self, name: str) -> str:
        """Generates a React component scaffold."""
        return f'''import React, {{ useState, useEffect }} from 'react';
import axios from 'axios';

const {name} = () => {{
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {{
    fetchData();
  }}, []);

  const fetchData = async () => {{
    try {{
      const res = await axios.get('/api/endpoint');
      setData(res.data);
    }} catch (e) {{ console.error(e); }}
    finally {{ setLoading(false); }}
  }};

  return (
    <div className="{name.lower()}-container">
      {{loading ? <p>Loading...</p> : <pre>{{JSON.stringify(data, null, 2)}}</pre>}}
    </div>
  );
}};

export default {name};
'''

    def generate_api_endpoint(self, name: str, method: str = "GET") -> str:
        """Generates a FastAPI endpoint scaffold."""
        if method.upper() == "GET":
            return f'''@app.get("/api/{name.lower()}")
async def get_{name.lower()}(current_user: User = Depends(get_current_active_user)):
    """Gets {name} data."""
    # TODO: Implement logic
    return {{"status": "SUCCESS", "data": []}}
'''
        else:
            return f'''@app.post("/api/{name.lower()}")
async def create_{name.lower()}(payload: dict, current_user: User = Depends(get_current_active_user)):
    """Creates {name}."""
    # TODO: Implement logic
    return {{"status": "SUCCESS", "id": "new-id"}}
'''

    def generate_model(self, name: str, fields: List[str]) -> str:
        """Generates a Python model class."""
        field_defs = "\n    ".join([f"self.{f} = {f}" for f in fields])
        params = ", ".join(fields)
        dict_fields = ", ".join([f'"{f}": self.{f}' for f in fields])
        
        return f'''class {name}:
    def __init__(self, {params}):
        {field_defs}

    def to_dict(self):
        return {{{dict_fields}}}

    @classmethod
    def from_dict(cls, data):
        return cls(**data)
'''


# Global Instances
api_client_generator = APIClientGenerator()
code_scaffolder = CodeScaffolder()
